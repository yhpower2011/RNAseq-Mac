#!/bin/bash
set -euo pipefail
set -x  # DEBUG: Print commands as they are executed

# Extend PATH so Homebrew-installed tools (fastqc, STAR, etc.) are found.
export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin"

# --------- CONFIGURATION ---------
# Set the number of CPU threads to use.
threads=4

# Paths to reference files (update these if needed)
STAR_INDEX="/path/to/STAR_index"       # e.g., directory built with STAR --genomeGenerate
GTF_FILE="/path/to/annotation.gtf"       # Full path to gene annotation GTF file

# Adapter sequences for trimming (example: Illumina TruSeq adapters)
adapter_fwd="AGATCGGAAGAGCACACGTCTGAACTCCAGTCA"
adapter_rev="AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT"

# List of project folders (each should contain a subfolder "raw_data" with FASTQ files)
projects=("RNAseq-a" "RNAseq-b" "RNAseq-c")
# ---------------------------------

echo "Starting RNA-seq pipeline..."

for project in "${projects[@]}"; do
  if [ ! -d "$project" ]; then
    echo "Warning: Project directory '$project' not found, skipping."
    continue
  fi
  
  echo "=============================="
  echo "Processing project: $project"
  
  cd "$project"

  if [ ! -d "raw_data" ]; then
    echo "Error: 'raw_data' subfolder not found in $project. Skipping project."
    cd ..
    continue
  fi

  mkdir -p fastqc_raw trimmed star_out

  # Look for paired-end FASTQ files in raw_data folder:
  shopt -s nullglob
  fastq_files=(raw_data/*_R1.fastq.gz)
  if [ ${#fastq_files[@]} -eq 0 ]; then
    echo "No FASTQ files matching '*_R1.fastq.gz' found in $project/raw_data. Skipping project."
    cd ..
    continue
  fi

  for R1 in raw_data/*_R1.fastq.gz; do
    R2="${R1/_R1.fastq.gz/_R2.fastq.gz}"
    if [ ! -f "$R2" ]; then
      echo "Warning: Matching R2 file for $R1 not found. Skipping sample."
      continue
    fi

    r1_basename=$(basename "$R1")
    sample="${r1_basename%%_R1.fastq.gz}"
    echo "Processing sample: $sample"

    # --- Step 1: FastQC on raw reads ---
    if [ ! -f "fastqc_raw/${r1_basename%%.fastq.gz}_fastqc.html" ] || \
       [ ! -f "fastqc_raw/$(basename "$R2" .fastq.gz)_fastqc.html" ]; then
      echo "Running FastQC on $sample..."
      fastqc --quiet -t 2 -o fastqc_raw "$R1" "$R2"
      echo "FastQC completed for $sample."
    else
      echo "FastQC reports exist for $sample; skipping FastQC."
    fi

    # --- Step 2: Adapter trimming using cutadapt ---
    trimmed_R1="trimmed/${sample}_R1_trimmed.fastq.gz"
    trimmed_R2="trimmed/${sample}_R2_trimmed.fastq.gz"
    if [ ! -f "$trimmed_R1" ] || [ ! -f "$trimmed_R2" ]; then
      echo "Trimming adapters for $sample..."
      cutadapt -j "$threads" -a "$adapter_fwd" -A "$adapter_rev" \
               -o "$trimmed_R1" -p "$trimmed_R2" "$R1" "$R2"
      echo "Trimming completed for $sample."
    else
      echo "Trimmed files exist for $sample; skipping trimming."
    fi

    # --- Step 3: STAR Alignment ---
    aligned_bam="star_out/${sample}_Aligned.sortedByCoord.out.bam"
    if [ ! -f "$aligned_bam" ]; then
      echo "Running STAR alignment for $sample..."
      STAR --runThreadN "$threads" \
           --genomeDir "$STAR_INDEX" \
           --readFilesIn "$trimmed_R1" "$trimmed_R2" \
           --readFilesCommand zcat \
           --outFileNamePrefix "star_out/${sample}_" \
           --outSAMtype BAM SortedByCoordinate \
           --outSAMunmapped Within \
           --sjdbGTFfile "$GTF_FILE"
      echo "STAR alignment completed for $sample."
    else
      echo "STAR alignment output exists for $sample; skipping alignment."
    fi

  done  # End sample loop

  # --- Step 4: featureCounts ---
  counts_file="../${project}_counts.txt"
  if [ ! -f "$counts_file" ]; then
    bam_files=(star_out/*_Aligned.sortedByCoord.out.bam)
    if [ ${#bam_files[@]} -gt 0 ]; then
      echo "Running featureCounts for $project on ${#bam_files[@]} BAM files..."
      featureCounts -T "$threads" -p -t exon -g gene_id -a "$GTF_FILE" -o "$counts_file" "${bam_files[@]}"
      echo "featureCounts completed for $project."
    else
      echo "No aligned BAM files in star_out; skipping featureCounts for $project."
    fi
  else
    echo "Counts file for $project already exists; skipping featureCounts."
  fi

  # --- Step 5: DESeq2 Differential Expression Analysis ---
  deseq_file="../${project}_deseq2_results.csv"
  if [ ! -f "$deseq_file" ]; then
    echo "Running DESeq2 analysis for $project..."
    Rscript --vanilla - <<'EOF'
suppressMessages(library(DESeq2))
args <- commandArgs(trailingOnly = TRUE)
counts_path <- args[1]
counts <- read.table(counts_path, header=TRUE, row.names=1, comment.char="#")
counts <- counts[ , -(1:5)]
samples <- colnames(counts)
conditions <- sapply(samples, function(x) { unlist(strsplit(x, "_"))[1] })
conditions <- factor(conditions)
coldata <- data.frame(condition=conditions, row.names=samples)
dds <- DESeqDataSetFromMatrix(countData = counts, colData = coldata, design = ~ condition)
dds <- DESeq(dds)
res <- results(dds)
res <- res[order(res$padj), ]
write.csv(as.data.frame(res), file=gsub("counts", "deseq2_results", counts_path))
EOF
    # Check if DESeq2 produced the results file.
    if [ -f "../${project}_deseq2_results.csv" ]; then
      echo "DESeq2 analysis completed for $project."
    else
      echo "DESeq2 analysis may have failed for $project."
    fi
  else
    echo "DESeq2 results for $project already exist; skipping DESeq2 analysis."
  fi

  cd ..
  echo "Finished processing project: $project"
done

echo "RNA-seq pipeline completed for all projects."
